<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patisflix</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #141414;
            color: white;
        }

        .disclaimer {
            color: white;
            font-size: 12px;
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #555;
            text-align: center;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 50px;
            position: fixed;
            width: 100%;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
        }

        .navbar img {
            height: 40px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-right i {
            font-size: 20px;
            cursor: pointer;
        }

        .nav-right img {
            height: 30px;
            border-radius: 4px;
        }

        .banner {
            height: 70vh;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 50px;
            position: relative;
        }

        .banner::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 7.4rem;
            background-image: linear-gradient(
                180deg,
                transparent,
                rgba(37, 37, 37, 0.61),
                #141414
            );
        }

        .banner-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 20px;
            max-width: 50%;
        }

        .banner-buttons {
            display: flex;
            gap: 15px;
        }

        .banner-button {
            padding: 8px 25px;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .banner-button.play {
            background-color: white;
            color: black;
        }

        .banner-button.info {
            background-color: rgba(109, 109, 110, 0.7);
            color: white;
        }

        .row {
            padding: 20px 50px;
            position: relative;
            z-index: 10;
        }

        .row-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .row-list {
            display: flex;
            gap: 10px;
            overflow-x: scroll;
            scrollbar-width: none;
        }

        .row-list::-webkit-scrollbar {
            display: none;
        }

        .row-list img {
            height: 150px;
            border-radius: 4px;
            transition: transform 0.3s;
            cursor: pointer;
        }

        .row-list img:hover {
            transform: scale(1.1);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background-color: #181818;
            width: 80%;
            max-width: 900px;
            border-radius: 8px;
            overflow: hidden;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(0,0,0,0.5);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-video {
            width: 100%;
            height: 400px;
            border: none;
        }

        .modal-body {
            padding: 20px;
            display: flex;
            gap: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 400px); /* Adjust based on video height */
        }

        .modal-image {
            width: 200px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .modal-info {
            flex: 1;
            min-width: 0; /* Prevent flex item from overflowing */
        }

        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .modal-rating {
            color: #46d369;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .modal-description {
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .server-select {
            padding: 8px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            margin-bottom: 15px;
            width: 100%;
        }

        /* Scrollbar styling */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #333;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Series Navigation */
        .series-nav {
            margin-bottom: 15px;
        }

        .season-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .season-btn {
            padding: 5px 10px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .season-btn.active {
            background-color: #e50914;
        }

        .episode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }

        .episode-card {
            background-color: #333;
            border-radius: 4px;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .episode-card:hover {
            background-color: #444;
        }

        .episode-card.active {
            background-color: #e50914;
        }

        .episode-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .episode-title {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Search Modal */
        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            z-index: 1000;
            flex-direction: column;
            padding: 80px 50px;
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .search-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 1.5rem;
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #333;
            color: white;
            outline: none;
        }

        .search-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .search-results img {
            width: 100%;
            border-radius: 4px;
            transition: transform 0.3s;
            cursor: pointer;
        }

        .search-results img:hover {
            transform: scale(1.05);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                padding: 15px;
            }

            .banner {
                padding: 0 20px;
                height: 60vh;
            }

            .banner-title {
                font-size: 2rem;
                max-width: 100%;
            }

            .row {
                padding: 20px;
            }

            .modal-body {
                flex-direction: column;
            }

            .modal-image {
                width: 100%;
            }

            .modal-video {
                height: 250px;
            }

            .episode-selector {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <img src="https://blogger.googleusercontent.com/img/a/AVvXsEiiZjh5HV9KWDzC56QoPC9NLXF5mZzoPCWt8NhaE1nCoNCvHdfuEScH47SK1lZRs1UMoyIfhaYHvziiB8h_k1z3qphky4CiXFsg_b8mV5DpgFLFJp9gi4vHxtOdjmsDDbC7iuAKotlHATJAMMuAkZ3YXs1bBwNC2whY3aQz5B9xC1DzqwoEJ3_g-m_MU6K_=s301" alt="Streamflix Logo">
        <div class="nav-right">
            <i class="fas fa-search" onclick="openSearchModal()"></i>
        </div>
    </nav>

    <!-- Banner -->
    <div class="banner" id="banner">
        <h1 class="banner-title" id="banner-title"></h1>
        <div class="banner-buttons">
            <button class="banner-button play"><i class="fas fa-play"></i> Play</button>
            <button class="banner-button info"><i class="fas fa-info-circle"></i> More Info</button>
        </div>
    </div>

    <!-- Rows -->
    <div class="row">
        <h2 class="row-title">Trending Movies</h2>
        <div class="row-list" id="movies-list"></div>
    </div>

    <div class="row">
        <h2 class="row-title">Trending TV Shows</h2>
        <div class="row-list" id="tvshows-list"></div>
    </div>

    <div class="row">
        <h2 class="row-title">Anime</h2>
        <div class="row-list" id="anime-list"></div>
    </div>

    <!-- Details Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                <iframe class="modal-video" id="modal-video" allowfullscreen></iframe>
            </div>
            <div class="modal-body">
                <img class="modal-image" id="modal-image" alt="Movie Poster">
                <div class="modal-info">
                    <h2 class="modal-title" id="modal-title"></h2>
                    <div class="modal-rating" id="modal-rating"></div>
                    <select class="server-select" id="server" onchange="changeServer()">
                        <option value="vidsrc.me">Server 1</option>
                        <option value="player.videasy.net">Server 2</option>
                        <option value="multiembed.mov">Server 3</option>
                        <option value="moviesapi.club">Server 4</option>
                        <option value="vidlink.pro">Server 5</option>
                    </select>
                    
                    <!-- Series Navigation -->
                    <div class="series-nav" id="series-nav" style="display: none;">
                        <div class="season-selector" id="season-selector"></div>
                        <div class="episode-selector" id="episode-selector"></div>
                    </div>
                    
                    <p class="modal-description" id="modal-description"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="search-modal" id="search-modal">
        <div class="search-header">
            <input type="text" class="search-input" id="search-input" placeholder="Search for movies, TV shows..." oninput="searchTMDB()">
            <button class="search-close" onclick="closeSearchModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="search-results" id="search-results"></div>
    </div>

    <script>
        const API_KEY = '8359ef4d106ac8e1719de6421aa6015a';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_URL = 'https://image.tmdb.org/t/p/original';
        let currentItem;
        let currentSeason = 1;
        let currentEpisode = 1;

        async function fetchTrending(type) {
            const res = await fetch(`${BASE_URL}/trending/${type}/week?api_key=${API_KEY}`);
            const data = await res.json();
            return data.results;
        }

        async function fetchTrendingAnime() {
            let allResults = [];

            // Fetch from multiple pages to get more anime (max 3 pages for demo)
            for (let page = 1; page <= 3; page++) {
                const res = await fetch(`${BASE_URL}/trending/tv/week?api_key=${API_KEY}&page=${page}`);
                const data = await res.json();
                const filtered = data.results.filter(item =>
                    item.original_language === 'ja' && item.genre_ids.includes(16)
                );
                allResults = allResults.concat(filtered);
            }

            return allResults;
        }

        async function fetchTVSeasons(tvId) {
            const res = await fetch(`${BASE_URL}/tv/${tvId}?api_key=${API_KEY}`);
            const data = await res.json();
            return data.seasons;
        }

        async function fetchSeasonEpisodes(tvId, seasonNumber) {
            const res = await fetch(`${BASE_URL}/tv/${tvId}/season/${seasonNumber}?api_key=${API_KEY}`);
            const data = await res.json();
            return data.episodes;
        }

        function displayBanner(item) {
            document.getElementById('banner').style.backgroundImage = `linear-gradient(to right, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%), url(${IMG_URL}${item.backdrop_path})`;
            document.getElementById('banner-title').textContent = item.title || item.name;

            // Set banner buttons to open the modal
            document.querySelector('.banner-button.play').onclick = () => showDetails(item);
            document.querySelector('.banner-button.info').onclick = () => showDetails(item);
        }

        function displayList(items, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                if (!item.poster_path) return;

                const img = document.createElement('img');
                img.src = `${IMG_URL}${item.poster_path}`;
                img.alt = item.title || item.name;
                img.onclick = () => showDetails(item);
                container.appendChild(img);
            });
        }

        async function showDetails(item) {
            currentItem = item;
            document.getElementById('modal-title').textContent = item.title || item.name;
            document.getElementById('modal-description').textContent = item.overview;
            document.getElementById('modal-image').src = `${IMG_URL}${item.poster_path}`;

            // Create star rating (0-5 stars based on vote_average)
            const rating = Math.round(item.vote_average / 2);
            document.getElementById('modal-rating').innerHTML = '★'.repeat(rating) + '☆'.repeat(5 - rating) + ` (${item.vote_average.toFixed(1)}/10)`;

            // Show series navigation only for TV shows
            const seriesNav = document.getElementById('series-nav');
            if (item.media_type === 'tv' || (item.media_type === undefined && item.name)) {
                seriesNav.style.display = 'block';
                await loadSeasons(item.id);
            } else {
                seriesNav.style.display = 'none';
            }

            document.getElementById('modal').style.display = 'flex';
            changeServer(); // This will now trigger the auto-play
        }

        async function loadSeasons(tvId) {
            const seasons = await fetchTVSeasons(tvId);
            const seasonSelector = document.getElementById('season-selector');
            seasonSelector.innerHTML = '';
            
            seasons.forEach(season => {
                if (season.season_number === 0) return; // Skip special seasons
                
                const btn = document.createElement('button');
                btn.className = 'season-btn';
                btn.textContent = `Season ${season.season_number}`;
                btn.onclick = () => {
                    document.querySelectorAll('.season-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    loadEpisodes(tvId, season.season_number);
                };
                
                // Activate first season by default
                if (season.season_number === 1) {
                    btn.classList.add('active');
                    loadEpisodes(tvId, 1);
                }
                
                seasonSelector.appendChild(btn);
            });
        }

        async function loadEpisodes(tvId, seasonNumber) {
            currentSeason = seasonNumber;
            const episodes = await fetchSeasonEpisodes(tvId, seasonNumber);
            const episodeSelector = document.getElementById('episode-selector');
            episodeSelector.innerHTML = '';
            
            episodes.forEach(episode => {
                const card = document.createElement('div');
                card.className = 'episode-card';
                card.innerHTML = `
                    <div class="episode-number">Episode ${episode.episode_number}</div>
                    <div class="episode-title" title="${episode.name}">${episode.name}</div>
                `;
                card.onclick = () => {
                    document.querySelectorAll('.episode-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    currentEpisode = episode.episode_number;
                    changeServer();
                };
                
                // Activate first episode by default
                if (episode.episode_number === 1) {
                    card.classList.add('active');
                    currentEpisode = 1;
                }
                
                episodeSelector.appendChild(card);
            });
            
            changeServer();
        }

        function changeServer() {
            const server = document.getElementById('server').value;
            const videoFrame = document.getElementById('modal-video');
            
            if (currentItem.media_type === 'tv' || (currentItem.media_type === undefined && currentItem.name)) {
                // TV Show
                videoFrame.src = `https://${server}/tv/${currentItem.id}/${currentSeason}/${currentEpisode}?autoplay=1`;
            } else {
                // Movie
                videoFrame.src = `https://${server}/movie/${currentItem.id}?autoplay=1`;
            }
            
            // Ensure the video plays when the source changes
            videoFrame.onload = function() {
                // Some servers might strip the autoplay parameter, so we add it again
                if (!videoFrame.src.includes('autoplay=1')) {
                    videoFrame.src = videoFrame.src + (videoFrame.src.includes('?') ? '&' : '?') + 'autoplay=1';
                }
            };
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('modal-video').src = ''; // Stop video when modal closes
        }

        // Initialize the page
        async function init() {
            try {
                const movies = await fetchTrending('movie');
                const tvShows = await fetchTrending('tv');
                const anime = await fetchTrendingAnime();
                
                displayBanner(movies[0]);
                displayList(movies, 'movies-list');
                displayList(tvShows, 'tvshows-list');
                displayList(anime, 'anime-list');
            } catch (error) {
                console.error('Error initializing:', error);
            }
        }

        // Search functionality
        async function searchTMDB() {
            const query = document.getElementById('search-input').value;
            if (query.length < 2) {
                document.getElementById('search-results').innerHTML = '';
                return;
            }
            
            const res = await fetch(`${BASE_URL}/search/multi?api_key=${API_KEY}&query=${query}`);
            const data = await res.json();
            
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            data.results.forEach(item => {
                if (!item.poster_path) return;
                
                const img = document.createElement('img');
                img.src = `${IMG_URL}${item.poster_path}`;
                img.alt = item.title || item.name;
                img.onclick = () => {
                    showDetails(item);
                    closeSearchModal();
                };
                resultsContainer.appendChild(img);
            });
        }

        function openSearchModal() {
            document.getElementById('search-modal').style.display = 'flex';
            document.getElementById('search-input').focus();
        }

        function closeSearchModal() {
            document.getElementById('search-modal').style.display = 'none';
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = '';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
            
            const searchModal = document.getElementById('search-modal');
            if (event.target === searchModal) {
                closeSearchModal();
            }
        };

        // Initialize the app
        init();
    </script>
</body>
</html>